#!/bin/bash -e

while [[ "$#" -gt 0 ]]; do
	case $1 in
		--tag) tag="$2"; shift ;;
		*) break;;
	esac
	shift
done

username=$1

backupName=$(date '+%Y-%m-%d')
if [[ ! -z "$tag" ]]; then
	backupName=$backupName-$tag
fi
targetFolder=/home/$username/backups/$backupName

if [[ -e "$targetFolder" ]]; then
	echo "$targetFolder exists. Specify --tag or delete this backup." >&2
	exit
fi

btrfs subvolume snapshot /home/$username $targetFolder
unlink $targetFolder/shared


btrfs subvolume snapshot -r /home/shared/$username $targetFolder/shared
btrfs property set -t s $targetFolder ro true
