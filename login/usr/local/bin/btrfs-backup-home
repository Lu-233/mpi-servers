#!/bin/bash -e

while [[ "$#" -gt 0 ]]; do
	case $1 in
		--tag) tag="$2"; shift ;;
		*) break;;
	esac
	shift
done

username=$1

backupName=$(date '+%Y-%m-%d')
if [[ ! -z "$tag" ]]; then
	backupName=$backupName-$tag
fi
targetFolder=/home/$username/backups/$backupName
sudo btrfs subvolume snapshot /home/$username $targetFolder
sudo unlink $targetFolder/shared


sudo btrfs subvolume snapshot -r /home/shared/$username $targetFolder/shared
sudo btrfs property set -t s $targetFolder ro true
